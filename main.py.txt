import os
from fastapi import FastAPI
from sqlalchemy.ext.asyncio import create_async_engine
from sqlalchemy import text

app = FastAPI()

db_url = os.environ["DATABASE_URL"].replace("postgresql://", "postgresql+asyncpg://", 1)
engine = create_async_engine(db_url, pool_pre_ping=True)

@app.get("/health")
async def health():
    async with engine.connect() as conn:
        v = (await conn.execute(text("SELECT 1"))).scalar_one()
    return {"ok": True, "db": v}

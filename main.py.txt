import os
from fastapi import FastAPI
from psycopg import connect

app = FastAPI(title="IoT Waste API")

DATABASE_URL = os.environ.get("DATABASE_URL")

def db():
    return connect(DATABASE_URL)

@app.get("/health")
def health():
    return {"status": "ok"}

@app.get("/trucks/current")
def trucks_current():
    sql = """
    SELECT
      t.id AS truck_id,
      t.name AS truck_name,
      v.time,
      v.geom_geojson
    FROM sensorthings.v_truck_current_position v
    JOIN sensorthings.things t ON t.id = v.thing_id
    WHERE (t.properties->>'type') = 'truck'
    ORDER BY t.id;
    """
    with db() as conn:
        with conn.cursor() as cur:
            cur.execute(sql)
            rows = cur.fetchall()

    # Retour GeoJSON pour Leaflet
    features = []
    for truck_id, truck_name, time, geom in rows:
        features.append({
            "type": "Feature",
            "geometry": geom,
            "properties": {
                "truck_id": truck_id,
                "truck_name": truck_name,
                "time": str(time)
            }
        })
    return {"type": "FeatureCollection", "features": features}
